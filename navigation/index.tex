\chapter{Index}

\begin{intro}

Dans ce chapitre nous verrons comment faire un ou plusieurs index\footnote{Je remercie ma sœur Enimie pour l'avoir rédigé en grande partie.}.

\end{intro}


\section{Faire un index simple avec \packagenoidx{MakeIndex}}\sindex[pkg]{MakeIndex}


\subsection{Principe de base}


Pour indexer un document, il faut utiliser le package \package{makeidx} et placer  dans le préambule la commande \csp{makeindex}.

\begin{latexcode}
\usepackage{makeidx}
\makeindex
\end{latexcode}

\subsubsection{Indexer son document}



On indexe son document avec  la commande \csp{index}\marg{entrée}\label{cmdindex}. L'entrée apparaît dans l'index sous la forme indiquée par l'argument \arg{entrée}, suivit du numéro de la page où cette commande est placée dans le texte. 

Dans l'exemple qui suit\footcite{eginhard}, l'index comporte ainsi cinq entrées: \enquote{Charlemagne}, \enquote{Adrien}, \enquote{Tassilon}, \enquote{Formose} et \enquote{Damase}:
%Changer l'exemple.

\begin{latexcode}
Tandis que Charle\index{Charlemagne} était à Rome, il convint
avec le pape Adrien\index{Adrien} qu’ils enverraient de concert
des ambassadeurs à Tassilon, duc de Bavière\index{Tassilon}
\textelp{}
Les hommes choisis et envoyés dans cette ambassade furent, de 
la part du pape, les évêques Formose\index{Formose} et 
Damase\index{Damase}\textelp{}.
\end{latexcode}



 Lorsqu'une entrée est référencée deux fois dans la même page, cette page n'est indiquée qu'une seule fois. 

\begin{attention}
Il vaut mieux accoler la commande \cs{index}\marg{entrée} directement au  mot à indexer, sans laisser d'espace, pour éviter toute ambiguité en cas de changement de page.

\end{attention}


L'indexation d'un texte n'est pas automatique: il faut placer \cs{index}\marg{entrée} à chaque endroit  que l'on veut référencer. On  peut bien sûr créer une commande  spécifique pour combiner l'indexation avec d'autres actions.

Ainsi, pour indexer automatiquement tous les noms propres d'un texte, déclarons la commande suivante:\label{indexauteur}

\begin{latexcode}
\newcommand\auteur[2]{#1~\textsc{#2}\index{#2, #1}\xspace}
\end{latexcode}

\renewcommand\auteur[2]{#1~\textsc{#2}\xspace}

Il suffit ensuite, au cours de la rédaction de son texte, de taper par exemple \cs{auteur}\verb|{Victor}{Hugo}| pour obtenir \enquote{\auteur{Victor}{Hugo}} dans le corps de son texte, indexé sous l'entrée \enquote{Hugo, Victor}.


\subsubsection{Générer l'index}

Si notre fichier principal s'appelle \fichier{exemple.tex}, lors de la première compilation, la commande \cs{makeindex} indique à \LaTeX{} de créer un fichier de type \fichier{exemple.idx}, contenant la liste de toutes les entrées que l'on a placées. 
 




On compile ensuite le document avec le programme MakeIndex, soit  en ligne de commande\renvoi{terminal}  soit via l'éditeur de texte, si celui-ci le propose.

\begin{bashcode}
makeindex exemple.idx
\end{bashcode}

Il est possible de ne pas indiquer l'extension \ext{idx}.

\LaTeX{} génère alors un fichier \fichier{exemple.ilg} qui contient les messages de compilation de l'index, et un fichier \fichier{exemple.ind} qui contient l'index formaté.




Il suffit alors de compiler à nouveau le document principal pour y intégrer son index, qui apparaît à l'emplacement que l'on a indiqué par la commande \csp{printindex}.

\begin{plusloins}
L'index n'apparaît pas dans la table des matières. Nous indiquons sur notre blog comment faire pour qu'il apparaisse. Un collègue y indique également en réaction sa méthode, qui consiste à passer par le package \package{imakeidx}\footcite{indextoc}.

Nous parlons dans un autre chapitre de  la façon de  modifier la présentation de l'index.\renvoi{styleindex}
\end{plusloins}
\subsection{Allons plus loin}
\subsubsection{Créer des subdivisions}

Il est possible, avec \package{MakeIndex},  de créer des subdivisions et des subsubdivisions  pour chaque entrée de l'index. La subdivision se crée de la manière suivante : \begin{english}\cs{index}\verb|{|\meta{entrée}\verb|!|\meta{sous-entrée}\verb|}|\end{english}. La sous-sous-entrée, logiquement, se crée ainsi: \begin{english}\cs{index}\verb|{|\meta{entrée}\verb|!|\meta{sous-entrée}\verb|!|\meta{sous-sous-entrée}\verb|}|\end{english}. MakeIndex ne permet cependant que ces trois niveaux d'indexation.

On peut ainsi référencer autrement notre premier exemple, en créant les entrées \enquote{Evêques} et \enquote{Ducs} que l'on subdivise:

\begin{latexcode}
Tandis que Charle\index{Charlemagne} était à Rome, il convint 
avec le pape Adrien\index{Adrien} qu’ils enverraient de concert 
des ambassadeurs à Tassilon, duc de Bavière\index{Ducs!Tassilon}.
\textelp{}
Les hommes choisis et envoyés dans cette ambassade furent, de la 
part du pape, les évêques Formose\index{Evêques!Formose}
et Damase\index{Evêques!Damase}\textelp{}.
\end{latexcode}


Supposons que ce texte soit à la page 5; on obtient ainsi dans l'index:
\begin{quotation}
\begin{tabbing}
\hspace{0,5cm}  \= \kill
Adrien, 5 \\
\\
Charlemagne, 5 \\
\\
Ducs \\
\> Tassilon, 5\\
\\
Evêques \\
\> Damase, 5\\
\> Formose, 5\\

\end{tabbing}
\end{quotation}



Bien entendu, on pourrait encore rajouter une subdivision, en distinguant par exemple \enquote{Clercs} et \enquote{Laïcs}, et dans la première catégorie en distinguant \enquote{Evêques} et \enquote{Papes}. 


 
\subsubsection{Faire des références croisées}

Pour qu'une entrée dans l'index renvoie à une autre entrée, on utilise la commande  \cs{index}\verb|{|\meta{entrée}\verb+|see+\meta{entrée à laquelle on renvoie}\verb|}|. Ainsi,  \cs{index}\verb+{Tassilon|see{Ducs}}+ donne dans l'index:

\begin{quotation}
Tassilon, voir Ducs
\end{quotation}
La traduction de \emph{see} change selon la langue indiquée comme \cs{setmainlanguage}. \renvoi{french}



  

\subsubsection{Créer des entrées sur plusieurs pages}

Si l'on veut référencer dans l'index non pas un mot mais un passage, il faut placer la commande \cs{index}\verb|{|\meta{entrée}\verb+|(}+ au début du passage à indexer et la commande  \cs{index}\verb|{|\meta{entrée}\verb+|)}+ à la fin. Si le passage commence à la page x et se termine à la page y, on obtient dans l'index: 

\begin{quotation}
entrée x-y
\end{quotation}


\subsubsection{Entrées formatées}

Makeindex ne gère pas correctement les accents indiqués dans l'argument de la commande \cs{index} : il classe les mots commençant par un accent à la fin de l'index. La syntaxe \cs{index}\verb|{|\meta{entrée}\verb|@|\meta{entrée formatée}\verb+}+ permet de résoudre ce problème. Ainsi, si l'on veut créer une entrée \enquote{écrivains}, qui soit triée à \enquote{e}, il faut insérer \cs{index}\verb|{ecrivains@écrivains}|.

La commande \cs{index}\verb|{|\meta{entrée}\verb|@|\meta{entrée formatée}\verb+}+ permet donc de classer une entrée où l'on veut dans l'index. Pour faire apparaître dans l'index, par exemple, les empereurs romains dans l'ordre chronologique et non dans l'ordre alphabétique, on peut utiliser les commandes suivantes:

\begin{latexcode}
\index{Empereurs!empereur1@Auguste}
\index{Empereurs!empereur2@Tibère}
\index{Empereurs!empereur3@Claude}
et ainsi de suite. 
\end{latexcode}

On obtient alors :

\begin{quotation}
\begin{tabbing}
\hspace{0,5cm} \= \kill
Empereurs\\
\> Auguste, x\\
\> Tibère, y\\
\> Claude, z \\

\end{tabbing}
\end{quotation}

Cette syntaxe est aussi utile pour mettre en évidence une entrée dans l'index en modifiant son aspect. En mettant \cs{index}\verb|{|\meta{entrée}\verb|@\textbf{|meta{entrée formatée}\verb|}}|, l'entrée apparaît en gras dans l'index. Ceci est valable pour toutes les commandes agissant sur la fonte. Modifions ainsi comme suit la commande \cs{auteur} que l'on a créée précédemment :\renvoi{indexauteur}

\begin{latexcode}
\newcommand\auteur[2]{#1~\textsc{#2}\index{#2 #1@\textsc{#2}, #1}\xspace}
\end{latexcode}

Désormais, frapper \cs{auteur}\verb|{Victor}{Hugo}|donne
 \enquote{\textsc{Hugo},~Victor} dans l'index.
 
 

\subsubsection{Formater le numéro des pages}

Il peut arriver, lorsqu'une entrée est très souvent représentée dans un texte indexé, que l'on veuille mettre en valeur une de ses occurrences, en faisant apparaître en gras dans l'index le numéro de la page où elle se situe : on utilise alors la commande \cs{index}\verb|{|\meta{entrée}\verb+|textbf}+. 

De même pour faire apparaître le numéro de la page en italique va-t-on utiliser la commande \cs{index}\cs{index}\verb|{|\meta{entrée}\verb+|textit}+.

\begin{attention}
Il s'agit bien de \verb+|textbf+, non de \verb+|\textbf+
\end{attention}



\begin{plusloins}
Si vous utilisez le package \package{hyperref}, vous constaterez que celui-ci insère des liens hypertextes vers les pages au sein de l'index. Toutefois si une de ces pages est formatée, le lien disparaît. Nous expliquons sur notre site comment éviter ce problème\footnote{indexhypergras}.
\end{plusloins}



\section{\packagenoidx{SplitIndex}, ou comment faire plusieurs index}\sindex[pkg]{SplitIndex} \label{splitindex}


Le package se charge en remplaçant \cs{usepackage}\verb|{makeindex}| par \cs{usepackage}\verb|{splitidx}| tout en gardant ensuite \cs{makeindex} dans le préambule, ou bien en mettant simplement  \cs{usepackage}\verb|[makeindex]{splitidx}|.

\subsection{Définir ses index}

Le package \package{SplitIndex} permet de faire plusieurs index pour un même document. La première étape consiste à définir ces index. On les déclare dans le préambule par la commande \csp{newindex}\oarg{Nom de l'index}\marg{abbréviation}.


L'argument facultatif est le nom de l'index tel qu'il apparaît après la compilation du document. L'argument obligatoire doit être assez court, puisque c'est avec lui que vous indiquez à quel index appartient chaque entrée indexée dans votre document.


Ainsi, pour faire un index des noms propres et un index général, on peut déclarer:

\begin{latexcode}
\newindex[Index général]{idx}
\newindex[Noms propres]{npr}
\end{latexcode}

\subsection{Indexer son texte}
Une fois  les index déclarés, il faut passer à l'indexation proprement dite. Le principe est similaire à celui que nous avons déjà vu pour le package \package{makeindex}\renvoi{cmdindex}.

Mais au lieu de la commande \cs{index}\marg{entrée}, on utilise \csp{sindex}\oarg{abbréviation}\marg{entrée}. 

\begin{plusloins}

Toutes les entrées indiquées non par \cs{sindex} mais par \cs{index} sont automatiquement placées dans un index général, dont le nom abrégé est idx.

\end{plusloins}
On peut ainsi indexer notre texte d'Eginhard de la façon suivante:

\begin{latexcode}
\sindex[idx]{Charles et la papauté|(}
Tandis que Charle\sindex[npr]{Charlemagne} était à Rome, il convint
avec le pape Adrien\sindex[npr]{Adrien} qu’ils enverraient de concert
des ambassadeurs à Tassilon, duc de Bavière\sindex[npr]{Tassilon}
\textelp{}
Les hommes choisis et envoyés dans cette ambassade furent, de 
la part du pape, les évêques Formose\sindex[npr]{Formose} et 
Damase\sindex[npr]{Damase}(…)\sindex[idx]{Charles et la papauté|)}.
\end{latexcode}

Après la compilation avec \XeLaTeX il faut compiler le fichier \ext{idx} avec SplitIndex. En général, la seule solution est de passer par la ligne de commande\renvoi{terminal} :

\begin{bashcode}
splitindex exemple.idx
\end{bashcode}

\subsection{Imprimer les index}

Pour imprimer un index, il suffit d'utiliser la commande \csp{printindex} en lui passant le nom abrégé de l'index en option. Ainsi, pour imprimer l'index des noms propres:

\begin{latexcode}
\printindex[npr]
\end{latexcode}

Pour imprimer l'ensemble des index, il faut utiliser la commande \cs{printindex*}.
Par défaut, les index ont un titre de niveau \cs{chapter} dans la classe \classe{book} et de niveau \cs{section} dans la classe \classe{article}.

 Il est possible d'imprimer les index avec un titre de niveau immédiatement inférieur, pour regrouper par exemple  l'ensemble des index dans un chapitre divisé en autant de sections que d'index. Il faut utiliser dans ce cas la commande \csp{printsubindex}, ou \csp{printsubindex*} pour tous les imprimer.

Par exemple :

\begin{latexcode}
\chapter{Index}
\printsubindex*
\end{latexcode}

\section{Indexer ses sources}


Nous allons maintenant voir comment utiliser les possibilités de \package{biblatex} et de \package{splitindex} pour établir un index des sources primaires.

Pour comprendre cette section, vous devez vous être familiarisé avec les indications sur les macros bibliographiques\renvoi{macrobiblio} .



\subsection{Premier essai}

La documentation de \package{biblatex}\footcite{biblatex_options} nous informe qu'il existe  au chargement du package une option \option{indexing} qui permet d'indexer automatiquement les références bibliographiques. Comme nous ne souhaitons indexer que les références appelées par les commandes \cs{\meta{prefix}cite}  ---  et non celles appelées par la commande \cs{printbibliography} --- nous attribuons la valeur \option{cite} à cette option. 

\begin{latexcode}
\usepackage[indexing=cite]{biblatex}
\end{latexcode}

Étant donné qu'il faut à la fois interpréter le fichier \ext{bib} et faire un index, nous devons procéder aux compilations dans l'ordre suivant :

\begin{enumerate}
\item Compilation avec \XeLaTeX.
\item Compilation avec Biber (ou BibTeX).
\item Compilation avec \XeLaTeX pour que les données bibliographiques soit intégrées dans l'index.
\item Compilation avec Makeindex pour transformer le fichier \ext{idx} en \ext{ind}.
\item Compilation avec \XeLaTeX pour finir d'intégrer l'index dans le fichier \ext{pdf}
\end{enumerate}

On constate cependant deux problèmes : 
\begin{enumerate}
\item La bibliographie se trouve mêlée aux autres entrées de l'index.
\item Plus grave : au lieu d'avoir des entrées sous la forme : \begin{english}\verb|Auteur!Titre|\end{english}, nous avons des entrées pour les auteurs et des entrées pour les sources.
\end{enumerate}

En outre nous aimerions :
\begin{enumerate}
\item Limiter l'indexation aux sources primaires.
\item Indexer aussi, comme troisième niveau d'index, le champ \champ{titleaddon} qui nous sert pour les divisions de source. \renvoi{divisionsource}
\end{enumerate}

\subsection{Création d'un index spécifique}

Pour créer un index spécifique aux sources, rien de particulier : il suffit d'utiliser \package{splitindex} et la commande \cs{newindex} :

\begin{latexcode}
\newindex[Index des sources]{sources}
\end{latexcode}

\subsection{Modifications des macros de \packagenoidx{biblatex}}\sindex[pkg]{biblatex}

Nous avons donc notre index spécifique. Mais encore faut-il que nous disions  à \package{biblatex} d'y écrire son index. Pour ce faire nous allons d'abord redéfinir la macro \bibmacro{citeindex} qui est appelée à chaque commande \cs{\meta{prefix}cite}.

\inputminted{exemples/navigation/index-source/citeindex.tex}

\begin{description}
\item[ligne 2] la commande \csp{ifciteindex} vérifie que l'option \option{indexing} de \package{biblatex} est bien égale à \verb|true| ou bien à \verb|cite|: si tel est le cas ce qui suit entre accolades est exécuté.
\item[ligne 3] nous indexons le champ \champ{author}.  Nous utilisons le format d'indexation \verb|sources|.
\item[ligne 4] nous indexons le champ \champ{indextitle}. Si ce champ est vide \package{biblatex} utilise à la place le champ \champ{title}. Nous utilisons le format d'indexation \verb|sources|.
\item[ligne 5] nous indexons le champ \champ{titleaddon}. Nous utilisons le format d'indexation \verb|sources|.
\item[ligne 6] nous indexons la valeur \verb|---| dans le fichier \fichier{xxx-source.idx}. Cette valeur sert plus tard lors de l'exécution d'un script écrit dans le langage Python.\renvoi{python}. En effet, une des limitations de \package{biblatex} est qu'il ne peut indexer qu'un seul champ à la fois, et n'est pas capable, pour le moment, de produire des entrées d'index à plusieurs niveaux. 

Pour contourner cela, nous avons conçu un script qui concatène dans le fichier \ext{idx} trois indexations en une seule. Pour que ce script ne concatène pas ensemble des indexations qui ne doivent pas être concaténée, nous écrivons des fausses indexations sous la forme \verb|---|, qui servent de point de repère au script.
\end{description}

\subsection{Fomat d'indexation \packagenoidx{biblatex}}\sindex[pkg]{biblatex}

Nous avons dit que nous utilisions le format d'indexation \forme{source}. Un format d'indexation \package{biblatex}  est simplement la description de l'opération que \package{biblatex} effectue lorsqu'il doit indexer un champ. 

Il nous faut donc définir ce format grâce aux commandes \csp{DeclareIndexNameFormat} et \csp{DeclareIndexFieldFormat}.

\subsubsection{Indexation des noms}

\begin{english}
\begin{latexcode}
\DeclareIndexNameFormat{sources}{%
  \usebibmacro{index:name}{\sindex[sources]}{#1}{#3}{#5}{#7}
  }
\end{latexcode}
\end{english}

Nous disons en première ligne que nous déclarons un format d'indexation \verb|sources| pour les noms propres. Dans la ligne suivante, nous déclarons ce que nous faisons : nous appelons une macro \bibmacro{index:name}. 

Cette macro est déjà définie par \package{biblatex}. Elle reçoit plusieurs arguments. Le premier argument est la commande à exécuter : ici \cs{sindex}\verb|[sources]|, qui permet d'indexer dans l'index \verb|sources| défini plus haut. Les autres arguments sont repris des codes de \package{biblatex} et désignent les différentes parties du nom à indexer\footcite[Nous renvoyons le lecteur à la documentation de \package{biblatex} : ][]{biblatex_formats}.


\subsubsection{Indexation des autres champs}

\begin{latexcode}
\DeclareIndexFieldFormat{sources}{%
  \ifcurrentfield{indextitle}{\sindex[sources]{#1@\emph{#1}}}%
  {\sindex[sources]{#1}}%
  }
\end{latexcode}

La commande \cs{DeclareIndexFieldFormat} sert à déclarer la manière d'indexer les champs qui ne sont ni des listes ni des noms. La valeur \verb|#1| correspond à la valeur du champ à indexer. En deuxième ligne, nous vérifions grâce à la commande \csp{ifcurrentfield}, que le champ à indexer  est \champ{indextitle} : si c'est le cas, nous l'indexons dans l'index \verb|source| en mettant l'emphase sur le titre pour l'affichage final. Sinon, nous l'indexons simplement dans l'index \verb|source|.

\subsection{Compilation et concaténation des index}


Après la  compilation \XeLaTeX, nous obtenons un fichier \fichier{xxx.idx}. Si vous l'ouvrez vous constaterez que nous avons des entrées sous la forme : 

\begin{latexcode}
\indexentry[sources]{Author}{page}
\indexentry[sources]{Titleindex@\emph  {Titleindex}}{page}
\indexentry[sources]{Titleaddon}{page}
\indexentry[sources]{---}{page}
\end{latexcode}

Nous souhaitons remplacer ces entrées par des entrées sous la forme :

\begin{latexcode}
\indexentry[sources]{Author@Author!Titleindex@
\emph  {Titleindex}!Titleaddon@Titleaddon}{page}
\end{latexcode}

L'auteur de ces lignes a développé un script permettant d'automatiser cette transformation. Par ailleurs ce script modifie également l'ordre de tri pour tenir compte des accents.

Pour utiliser ce script, il vous faut :\label{python}
\begin{itemize}
\item Avoir le logiciel Python installé sur votre ordinateur. Ce logiciel est installé en standard sous Mac Os X et sur la plupart des distributions Linux, mais pas sous Windows\footcite{python_windows}.
\item Télécharger le script sur le site de l'auteur à l'adresse suivante : \url{http://geekographie.maieul.net/57}.
\item Mettre ce fichier dans le répertoire du fichier \ext{idx}. 
\item L'ouvrir et modifier la ligne 8 en remplaçant \verb|xxx.idx| par le nom du fichier à concaténer.
\item En ligne de commande\renvoi{terminal} se rendre dans le  répertoire, puis taper l'entrée : \verb|python index.py|.
\end{itemize}


Après cette concaténation nous devons compiler en ligne de commande, enfin de séparer les différents index :

\begin{bashcode}
splitindex xxx
\end{bashcode}


\subsection{Raffinement}

Nous souhaitons n'indexer que les sources primaires. La solution la plus simple est d'utiliser dans le fichier \ext{bib} un champ personnalisé \champ{usera}. Le package \package{biblatex} permet en effet à l'utilisateur d'utiliser librement un certain nombre de champs\footcite[La liste de ces champs est fournie dans][]{biblatex_custom_fields}.  Dans ce champ, mettre 1 si l'entrée est une source primaire, 2 si l'entrée est une source secondaire.

Il nous suffit de modifier la macro \bibmacro{citeindex}, en introduisant un test (ligne 2) sur la valeur du champ \champ{usera}, grâce à la commande \csp{iffieldequalstr}.
\inputminted{exemples/navigation/index-source/citeindex-usera.tex}

\subsection{Résumé des diverses compilations}

Pour obtenir un index des sources primaires, une fois tous les fichiers mis en place, il nous faut donc procéder dans le terminal aux opérations suivantes :
\begin{enumerate}
\item \verb|xelatex xxx.tex|
\item \verb|biber xxx|
\item \verb|xelatex xxx.tex|\footnote{Si un sommaire se situe en début d'ouvrage, il peut être nécéssaire de compiler plusieurs fois.}
\item \verb|python index.py|
\item \verb|splitindex xxx|
\item \verb|xelatex xxx|
\end{enumerate}

\begin{plusloins}
Évidemment, il peut être fastidieux de se souvenir de l'ensemble de ces opérations, de les faire et refaire,\ldots C'est pourquoi il est conseillé pour les personnes travaillant sous Linux et Mac Os X d'utiliser un programme nommé make\footnote{Pour les utilisateurs de Windows, il est possible aussi, moyennant certaines techniques, d'installer ce programme.}. 

L'idée du programme make est de décrire dans un fichier les opérations nécessaires au passage d'un ensemble de fichier a vers un fichier b. Le programme make exécute ces opérations uniquement si les fichiers  ont été modifiés. En outre make peut faire des tests pour éviter de compiler deux fois si cela n'est pas utile. Notre livre n'est pas assez long pour expliquer comment se servir de make. Nous renvoyons à d'autres travaux\footcite[On pourra consulter, par exemple :][]{makefile}.
\end{plusloins}

